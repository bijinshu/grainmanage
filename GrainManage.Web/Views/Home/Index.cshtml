@using GrainManage.Web
@model UserInfo
<div id="homePage" class="container" style="margin-top:20px;">
    <div class="row">
        <div class="col-md-12 ">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">基本信息</a>
                    </h3>
                </div>
                <div id="collapse1" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>用户名</th>
                                        <th>真实姓名</th>
                                        <th>性别</th>
                                        <th>手机</th>
                                        <th>QQ</th>
                                        <th>微信</th>
                                        <th>邮箱</th>
                                        <th>角色</th>
                                    </tr>
                                </thead>
                                <tbody v-cloak>
                                    <tr>
                                        <td>{{userInfo.UserName}}</td>
                                        <td>{{userInfo.RealName}}</td>
                                        <td>{{userInfo.Gender==1?'女':'男'}}</td>
                                        <td>{{userInfo.Mobile}}</td>
                                        <td>{{userInfo.QQ}}</td>
                                        <td>{{userInfo.Weixin}}</td>
                                        <td>{{userInfo.Email}}</td>
                                        <td>{{userInfo.RoleNames}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @if (Model.CompId > 0)
    {
        <div class="row">
            <div class="col-md-12 ">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse2">店铺信息</a>
                        </h4>
                    </div>
                    <div id="collapse2" class="panel-collapse collapse">
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>店铺名称</th>
                                            <th>店铺地址</th>
                                        </tr>
                                    </thead>
                                    <tbody v-cloak>
                                        <tr>
                                            <td>{{frmComp.Name}}</td>
                                            <td>{{frmComp.Address}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-danger">
                <div class="panel-heading ">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse3">修改密码</a>
                    </h4>
                </div>
                <div id="collapse3" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div class="tab-pane fade in active">
                            <form style="max-width:400px; padding: 15px; margin: auto auto;" role="form">
                                <input id="OldPwd" v-model="OldPwd" type="password" class="form-control input-lg" placeholder="原始密码" style="margin-top:20px;"
                                       data-toggle="popover" data-placement="top" data-content="密码不能为空,且只能由2-20个字符组成">
                                <input id="NewPwd" v-model="NewPwd" type="password" class="form-control input-lg" placeholder="新密码" style="margin-top:20px;margin-bottom:20px;"
                                       data-toggle="popover" data-placement="top" data-content="密码不能为空,且只能由2-20个字符组成">
                                <button v-on:click.stop.prevent="changePwd" v-bind:disabled="IsDisabled" class="btn btn-lg btn-primary btn-block">保存</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @if (Model.CompId < 0)
    {
        @Html.Partial("_CompanyDetail")
    }
    <modal-dialog title="提示" v-bind:msg="msg"></modal-dialog>
</div>
<script src="~/js/Crypto/sha1.js"></script>
<script>
    $(function () {
        new Vue({
            el: '#homePage',
            data: {
                msg: '',
                frmComp: {
                    Name: '',
                    Address: ''
                },
                userInfo: {
                    CompId:0,
                    UserName: '',
                    RealName: '',
                    Gender: '',
                    Mobile: '',
                    QQ: '',
                    Weixin: '',
                    Email: '',
                    RoleNames: ''
                },
                OldPwd: '',
                NewPwd: '',
                IsDisabled: false,
            },
            methods: {
                getBasicInfo: function (event) {
                    $.post('@UrlVar.User_Info').always(function (result, status) {
                        if (result.code == 1) {
                            this.userInfo.UserName = result.data.UserName;
                            this.userInfo.RealName = result.data.RealName;
                            this.userInfo.Gender = result.data.Gender;
                            this.userInfo.Mobile = result.data.Mobile;
                            this.userInfo.QQ = result.data.QQ;
                            this.userInfo.Weixin = result.data.Weixin;
                            this.userInfo.Email = result.data.Email;
                            this.userInfo.RoleNames = result.data.RoleNames;
                            this.userInfo.CompId = result.data.CompId;
                            if (this.userInfo.CompId < 0) {
                                this.showPanel("#saveCompanyModal");
                            } else {
                                this.frmComp.Name = result.data.ShopName ? result.data.ShopName : '';
                                this.frmComp.Address = result.data.ShopAddress ? result.data.ShopAddress : '';
                            }
                        }
                    }.bind(this));
                },
                changePwd: function (event) {
                    if (!this.isPwdValid(this.OldPwd)) {
                        $("#OldPwd").popover('show');
                    }
                    else if (!this.isPwdValid(this.NewPwd)) {
                        $("#NewPwd").popover('show');
                    }
                    else if (this.OldPwd == this.NewPwd) {
                        this.showAlert('两次输入的密码不允许相同');
                    }
                    else {
                        this.IsDisabled = true;
                        var sha = new sha1();
                        $.post('@UrlVar.User_ChangePwd', { OldPwd: sha.encrypt(this.OldPwd), NewPwd: sha.encrypt(this.NewPwd) }).always(function (result, status) {
                            this.IsDisabled = false;
                            this.showAlert(result.msg);
                        }.bind(this));
                    }
                },
                isPwdValid: function (pwd) {
                    return (/^.{2,20}$/g).test(pwd);
                },
                saveComp: function (event) {
                    if (this.isCompanyNameValid && this.isAddressValid) {
                        this.IsDisabled = true;
                       $.post('@UrlVar.Home_PerfectComp', this.frmComp).always(function (result, status) {
                           this.IsDisabled = false;
                           if (result.code==1) {
                               window.location.reload(true);
                           } else {
                               this.showAlert(result.msg);
                           }
                        }.bind(this));
                    }
                }
            },
            computed: {
                isCompanyNameValid: function () {
                    return (/^[\u4E00-\u9FA5\uF900-\uFA2D,\w\-]{1,60}$/g).test(this.frmComp.Name);
                },
                isAddressValid: function () {
                    return (/^.{0,200}$/g).test(this.frmComp.Address);
                }
            },
            created: function () {
                this.getBasicInfo();
            }
        })
    })
</script>